<title>midipoli.html</title><h1>- Introdu&ccedil;&atilde;o</h1>
<p>Bom, muitos sabem que eu fiz um Interruptor MIDI (ou sintetizador como preferir) com um FPGA. Por&eacute;m poucos tem acesso a um FPGA principalmente para fazer algo t&atilde;o *simples*, ent&atilde;o resolvi fazer um com PIC 16F628A.</p>
<p>No come&ccedil;o queria fazer com um PIC menor, mas os menores n&atilde;o tem Receptor Serial via <strong><em>hardware</em></strong>, ent&atilde;o ficaria mais complicado implementar. Outro ponto, &eacute; que o pre&ccedil;o dos PIC's menores s&atilde;o praticamente os mesmos, ent&atilde;o era s&oacute; uma quest&atilde;o de espa&ccedil;o mesmo. Usando um PIC maior, fica mais espa&ccedil;o livre para futuras modifica&ccedil;&otilde;es caso seja necess&aacute;rio.</p>
<p>O PIC 16F628A tem 2KB de memoria flash, 224 Bytes de RAM, 128 Bytes de EEPROM, um Comparador, 3 Timers, e um Receptor Serial Universal. Est&aacute; no pacote DIP de 18 Pinos, e ele tem 2 portas de 8 bits (dependendo da configura&ccedil;&atilde;o, a porta A pode *perder* 3 bits.</p>
<p>Datasheet dele:&nbsp;<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/40044F.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/40044F.pdf</a></p>
<p>Ele tem um oscilador RC Interno de 4MHz calibrado de f&aacute;brica para +/- 1%, ent&atilde;o podemos fazer uso dele tranquilamente.</p>
<h1>- Protocolo MIDI</h1>
<p>Vamos falar um pouco antes do protocolo MIDI. O Sinal MIDI &eacute; basicamente um sinal Serial parecido com padr&atilde;o RS232. S&atilde;o 10 bits enviados, um bit para identificar o inicio (<em>start bit</em>), 8 bits de dados, e um bit para identificar o fim (<em>stop bit</em>). Ele s&oacute; n&atilde;o se encaixa na RS232 por causa de sua <em>Baud Rate </em>(velocidade com que os bits s&atilde;o transmitidos), que &eacute; 31250 Hz (ou 31.25 kBits por segundo). Por apenas sua <em>Baud Rate</em>&nbsp;ser fora de padr&atilde;o, podemos usar a porta serial universal do PIC, apenas usando 31250 como <em>Baud Rate</em>.</p>
<p>Outro ponto do Protocolo MIDI, &eacute; que todo dado MIDI &eacute; composto por 3 Bytes (24 bits), sendo o primeiro deles o byte de <strong>Opera&ccedil;&atilde;o</strong>, e os outros dois bytes de <strong>Dados</strong>. Para uma identifica&ccedil;&atilde;o mais&nbsp;f&aacute;cil de qual &eacute; qual, foi padronizado que se o primeiro bit (MSB) do byte for 1, &eacute; uma <strong>Opera&ccedil;&atilde;o</strong>, se for 0 &eacute; <strong>Dado</strong>. Assim caso a transmiss&atilde;o de algum byte falhe (principalmente o primeiro) &eacute; poss&iacute;vel saber.</p>
<p>A tabela simplificada abaixo associa os modos de opera&ccedil;&atilde;o e a fun&ccedil;&atilde;o de seus dados:</p>
<p style="text-align: center;"><img border=0 style="border: 0pt none;" title="Tabela do Protocolo MIDI" src="get.php@arquivo=1531"  alt="Tabela do Protocolo MIDI" width="558" height="127" /></p>
<p>Na tabela s&oacute; est&aacute; os mais comuns e tirando o <em>Pitch Bend, os que vamos usar.</em></p>
<p>Iremos ent&atilde;o fazer o PIC ler 3 bytes, e depois efetuar as opera&ccedil;&otilde;es necess&aacute;rias de acordo com o primeiro byte.</p>
<h1>- Notas musicais e Timer do PIC</h1>
<p>Outro detalhe importante s&atilde;o as notas musicais. O MIDI apenas envia o numero da nota, que varia de 0 a 127. Precisamos ent&atilde;o calcular o per&iacute;odo das notas.</p>
<p>A frequ&ecirc;ncia de uma dada nota musical, tem que dobrar a cada 12 notas. Para isso &eacute; dada a f&oacute;rmula:</p>
<blockquote>
<p><strong>Frequ&ecirc;ncia = FreqBase * 2^(n/12)</strong></p>
</blockquote>
<p>Onde <strong>Frequ&ecirc;ncia</strong>&nbsp;&eacute; a frequ&ecirc;ncia da nota que queremos, <strong>FreqBase</strong>&nbsp;&eacute; a frequ&ecirc;ncia da nota base, <strong>n </strong>&eacute; o numero da nota relativa a nota base. A nota que usaremos como base &eacute; a 10&ordf; nota, que tem sua frequ&ecirc;ncia em 27.5Hz. Para calcularmos o per&iacute;odo de uma nota &eacute; s&oacute; pegarmos o inverso da frequ&ecirc;ncia:</p>
<blockquote>
<p><strong>Per&iacute;odo = 1 / ( FreqBase * 2^(n/12) )</strong></p>
</blockquote>
<p>At&eacute; podemos calcular isso em tempo real no PIC, por&eacute;m podem haver atrasos muito grandes, ent&atilde;o faremos uma tabela com os per&iacute;odos das notas para usarmos.</p>
<p>Podemos usar o seguinte c&oacute;digo em PHP para calcularmos as frequ&ecirc;ncias:</p>
<pre><span class="cp" style="line-height: 13px; color: #cc3333;"><!--?</span-->

<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="m" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="m" style="line-height: 13px; color: #000000;">128</span><span class="p">;</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$freq</span> <span class="o">=</span> <span class="m" style="line-height: 13px; color: #000000;">27.5</span> <span class="o">*</span> <span class="nb" style="line-height: 13px; color: #00aaaa;">pow</span><span class="p">(</span><span class="m" style="line-height: 13px; color: #000000;">2</span><span class="p">,(</span><span class="nv">$i</span><span class="o">-</span><span class="m" style="line-height: 13px; color: #000000;">9</span><span class="p">)</span><span class="o">/</span><span class="m" style="line-height: 13px; color: #000000;">12</span><span class="p">);</span>
    <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">echo</span><span class="p">(</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">"Nota: </span><span class="si" style="line-height: 13px; color: #cc9933; font-weight: bold;">$i</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;"> Frequ&ecirc;ncia: </span><span class="si" style="line-height: 13px; color: #cc9933; font-weight: bold;">$freq</span><span class="se" style="line-height: 13px; color: #cc9933; font-weight: bold;">\r\n</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp" style="line-height: 13px; color: #cc3333;">?&gt;</span></span></pre>
<p>Link do Codepad:&nbsp;<a href="http://codepad.org/4GloHc3b">http://codepad.org/4GloHc3b</a></p>
<p>De maneira semelhante podemos fazer para o per&iacute;odo:</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre><span class="cp" style="line-height: 13px; color: #cc3333;"><!--?</span-->

<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="m" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="m" style="line-height: 13px; color: #000000;">128</span><span class="p">;</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$period</span> <span class="o">=</span> <span class="m" style="line-height: 13px; color: #000000;">1</span><span class="o">/</span> <span class="p">(</span><span class="m" style="line-height: 13px; color: #000000;">27.5</span> <span class="o">*</span> <span class="nb" style="line-height: 13px; color: #00aaaa;">pow</span><span class="p">(</span><span class="m" style="line-height: 13px; color: #000000;">2</span><span class="p">,(</span><span class="nv">$i</span><span class="o">-</span><span class="m" style="line-height: 13px; color: #000000;">9</span><span class="p">)</span><span class="o">/</span><span class="m" style="line-height: 13px; color: #000000;">12</span><span class="p">));</span>
    <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">echo</span><span class="p">(</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">"Nota: </span><span class="si" style="line-height: 13px; color: #cc9933; font-weight: bold;">$i</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;"> Periodo: </span><span class="si" style="line-height: 13px; color: #cc9933; font-weight: bold;">$period</span><span class="se" style="line-height: 13px; color: #cc9933; font-weight: bold;">\r\n</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp" style="line-height: 13px; color: #cc3333;">?&gt;</span></span></pre>
<p>Link do Codepad:&nbsp;<a href="http://codepad.org/yqXDTXQZ">http://codepad.org/yqXDTXQZ</a></p>
<p>No PIC, usaremos o <strong>TIMER1</strong> como refer&ecirc;ncia, ele &eacute; um timer de <strong>16 bits</strong>, ou seja conta de <strong>0</strong> a <strong>65535</strong>. Faremos ele incrementar de 1 em 1 micro segundo, ent&atilde;o colocaremos o&nbsp;per&iacute;odo&nbsp;em micro segundos. Outro detalhe &eacute; que depois que o timer est&aacute; rodando, n&atilde;o podemos para-lo. Precisamos esperar ele chegar at&eacute; o fim, ent&atilde;o faremos ele contar apenas o necess&aacute;rio (o per&iacute;odo). Sendo o m&aacute;ximo dele de <strong>65535</strong>, ao iniciar uma nota, colocaremos <strong>65535-per&iacute;odo</strong>&nbsp;em seu valor inicial, assim ele contar&aacute; apenas o tempo do&nbsp;per&iacute;odo. Faremos ent&atilde;o um script que j&aacute; gere um <em>array</em>&nbsp;com os valores que precisamos de cada nota:</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre><span style="font-family: 'Times New Roman'; line-height: 17px; white-space: normal; background-color: #f6f6f6; font-size: medium;"><pre><span class="cp" style="line-height: 13px; color: #cc3333;"><!--?</span-->
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">echo</span> <span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">" const unsigned int16 notas[] = {"</span><span class="p">;</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="m" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="m" style="line-height: 13px; color: #000000;">128</span><span class="p">;</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$period</span> <span class="o">=</span> <span class="m" style="line-height: 13px; color: #000000;">65535</span><span class="o">-</span><span class="nb" style="line-height: 13px; color: #00aaaa;">round</span><span class="p">(</span><span class="m" style="line-height: 13px; color: #000000;">1000000</span> <span class="o">/</span> <span class="p">(</span><span class="m" style="line-height: 13px; color: #000000;">27.5</span> <span class="o">*</span> <span class="nb" style="line-height: 13px; color: #00aaaa;">pow</span><span class="p">(</span><span class="m" style="line-height: 13px; color: #000000;">2</span><span class="p">,(</span><span class="nv">$i</span><span class="o">-</span><span class="m" style="line-height: 13px; color: #000000;">9</span><span class="p">)</span><span class="o">/</span><span class="m" style="line-height: 13px; color: #000000;">12</span><span class="p">)));</span>
    <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="nv">$i</span><span class="o">==</span><span class="m" style="line-height: 13px; color: #000000;">0</span><span class="p">)</span> <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">echo</span><span class="p">(</span><span class="nv">$period</span><span class="p">);</span> <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">else</span> <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">echo</span><span class="p">(</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">",</span><span class="si" style="line-height: 13px; color: #cc9933; font-weight: bold;">$period</span><span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">echo</span> <span class="s2" style="line-height: 13px; color: #cc9933; font-weight: bold;">"};"</span><span class="p">;</span>
<span class="cp" style="line-height: 13px; color: #cc3333;">?&gt;</span></span></pre>
</span></pre>
<p>Link do codepad:&nbsp;<a href="http://codepad.org/yUNkOm7V">http://codepad.org/yUNkOm7V</a></p>
<pre>const unsigned int16 notas[] = {4379,
7811,11051,14109,16995,19720,22291,24718,27009,29171,31212,33139,34957,
36673,38293,39822,41265,42627,43913,45127,46272,47353,48374,49337,50246,
51104,51914,52679,53400,54081,54724,55331,55904,56444,56954,57436,57890,
58320,58725,59107,59468,59808,60130,60433,60719,60990,61245,61485,61713,
61927,62130,62321,62501,62672,62832,62984,63127,63262,63390,63510,63624,
63731,63832,63928,64018,64103,64184,64259,64331,64399,64462,64523,64579,
64633,64684,64731,64777,64819,64859,64897,64933,64967,64999,65029,65057,
65084,65109,65133,65156,65177,65197,65216,65234,65251,65267,65282,65296,
65310,65322,65334,65345,65356,65366,65376,65385,65393,65401,65408,65416,
65422,65429,65435,65440,65446,65451,65455,65460,65464,65468,65472,65475,
65479,65482,65485,65488,65490,65493,65495};
</pre>
<p><br /> Isso j&aacute; nos da o array com os valores que teremos que colocar no <strong>TIMER1</strong>. Assim podemos facilmente agora come&ccedil;ar a programar :D</p>
<h1>- Programa do PIC</h1>
<p>O programa do PIC n&atilde;o &eacute; t&atilde;o complexo assim. Usaremos o <em>CCS C</em>&nbsp;como compilador C, mas o programa pode ser facilmente adaptado a qualquer outro compilador. Usaremos a Interrup&ccedil;&atilde;o da <em>USART</em>&nbsp;para receber os bytes e armazena-los numa array de 3 bytes. Ap&oacute;s completar os 3 bytes, ele vai marcar uma vari&aacute;vel como 1 para sabermos que recebemos os 3 bytes.</p>
<p>Definiremos duas vari&aacute;veis do tipo <em>int16</em>&nbsp;para&nbsp;per&iacute;odo&nbsp;e tOn (tempo ligado), uma <em>array de char</em>&nbsp;de tamanho 3 para os bytes, duas <em>int1</em>&nbsp;para identificar se h&aacute; alguma nota ligada&nbsp;e para marcar o buffer de 3 bytes como carregado, duas vari&aacute;veis do tipo <em>int</em>&nbsp;para fazer a contagem dos bytes recebidos e para guardar o numero da nota carregada.</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre><span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">unsigned</span> <span class="n">int16</span> <span class="n">tOn</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">250</span><span class="p">;</span>    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//tOn</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">unsigned</span> <span class="n">int16</span> <span class="n">period</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>   <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Per&iacute;odo</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="n">int1</span> <span class="n">noteOn</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>             <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Nota Ligada</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="n">int8</span> <span class="n">loadedNote</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>         <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Nota Carregada</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">3</span><span class="p">];</span>              <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Buffer de Bytes</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="n">int1</span> <span class="n">buffer_loaded</span><span class="p">;</span>          <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Estado do Buffer</span>
<span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">static</span> <span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">int</span>  <span class="n">buffer_counter</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>     <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Contador do Buffer</span></pre>
<p>Assim definimos as vari&aacute;veis que iremos usar no c&oacute;digo. Agora iremos a fun&ccedil;&atilde;o da interrup&ccedil;&atilde;o da porta serial. O <em>CCS C</em>&nbsp;identifica a interrup&ccedil;&atilde;o serial do PIC como <strong>INT_RDA</strong>, ent&atilde;o iremos colocar uma fun&ccedil;&atilde;o para ela:</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre><span class="cp" style="line-height: 13px; color: #cc3333;">#int_rda </span>
<span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">void</span> <span class="nf">serial_isr</span><span class="p">()</span> 
<span class="p">{</span> 
   <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="n">buffer_counter</span><span class="o">!=</span><span class="mi" style="line-height: 13px; color: #000000;">3</span><span class="p">)</span> <span class="p">{</span>             <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se ainda n&atilde;o leu 3 bytes</span>
      <span class="n">buffer</span><span class="p">[</span><span class="n">buffer_counter</span><span class="p">]</span><span class="o">=</span><span class="n">getc</span><span class="p">();</span>   <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Ler o byte e guardar no buffer</span>
      <span class="n">buffer_counter</span><span class="o">++</span><span class="p">;</span>
      <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="n">buffer_counter</span><span class="o">==</span><span class="mi" style="line-height: 13px; color: #000000;">3</span><span class="p">)</span> <span class="p">{</span>          <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se ler 3 bytes, </span>
         <span class="n">buffer_counter</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>           <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Resetar o contador</span>
         <span class="n">buffer_loaded</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">1</span><span class="p">;</span>            <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Marcar o buffer como carregado</span>
      <span class="p">}</span><span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">else</span><span class="p">{</span>                           <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se n&atilde;o</span>
         <span class="n">buffer_loaded</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>            <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Manter o status do buffer como 0</span>
      <span class="p">}</span>
   <span class="p">}</span><span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">else</span>                               <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Caso receber algum byte com o buffer</span>
      <span class="n">getc</span><span class="p">();</span>                          <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//carregado, descartar o byte.</span>
<span class="p">}</span></pre>
<p>Com isso, estaremos recebendo os bytes e armazenando no buffer. Iremos agora ent&atilde;o fazer a interrup&ccedil;&atilde;o do <strong>TIMER1</strong>&nbsp;que ir&aacute; fazer a contagem. Nessa interrup&ccedil;&atilde;o iremos apenas fazer ele setar o valor correto em si mesmo cada vez que sua contagem chegar ao fim. A interrup&ccedil;&atilde;o &eacute; acionada toda vez que o <strong>TIMER1</strong>&nbsp;termina de contar. Ou seja, ap&oacute;s 65535 us no nosso caso.</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre><span class="cp" style="line-height: 13px; color: #cc3333;">#INT_TIMER1</span>
<span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">void</span> <span class="nf">resetTimer1</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">set_timer1</span><span class="p">(</span><span class="n">period</span><span class="p">);</span>
<span class="p">}</span></pre>
<p>&nbsp;</p>
<p>Iremos agora para a rotina principal, onde iremos fazer todo trabalho <span style="text-decoration: line-through;">pesado</span>.</p>
<p>Precisamos fazer a inicializa&ccedil;&atilde;o do PIC, faremos tudo isso dentro da <em>void main()</em>.</p>
<p>Iremos definir uma vari&aacute;vel do tipo <em>int16</em>&nbsp;para podermos guardar temporariamente a posi&ccedil;&atilde;o do <strong>TIMER1</strong>&nbsp;no c&oacute;digo.</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre><span class="kt" style="line-height: 13px; color: #9966cc; font-weight: bold;">void</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">int16</span> <span class="n">pos</span><span class="p">;</span>
   <span class="n">setup_timer_0</span><span class="p">(</span><span class="n">RTCC_INTERNAL</span><span class="o">|</span><span class="n">RTCC_DIV_1</span><span class="p">);</span>
   <span class="n">setup_timer_1</span><span class="p">(</span><span class="n">T1_INTERNAL</span><span class="o">|</span><span class="n">T1_DIV_BY_1</span><span class="p">);</span>
   <span class="n">setup_timer_2</span><span class="p">(</span><span class="n">T2_DISABLED</span><span class="p">,</span><span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">,</span><span class="mi" style="line-height: 13px; color: #000000;">1</span><span class="p">);</span>
   <span class="n">setup_comparator</span><span class="p">(</span><span class="n">NC_NC_NC_NC</span><span class="p">);</span>
   <span class="n">setup_vref</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
   <span class="n">enable_interrupts</span><span class="p">(</span><span class="n">global</span><span class="p">);</span>
   <span class="n">enable_interrupts</span><span class="p">(</span><span class="n">INT_TIMER1</span><span class="p">);</span> 
   <span class="n">enable_interrupts</span><span class="p">(</span><span class="n">INT_RDA</span><span class="p">);</span> </pre>
<p>&nbsp;</p>
<p>Com isso iremos ter inicializado tudo que precisamos. Agora vamos aos "<em>checks</em>". Usaremos o pino A0 para sa&iacute;da do interruptor, e A1 como <em>Enable</em>, A2 como sa&iacute;da para representar o PIC como "ocupado".</p>
<p><span style="font-family: 'Times New Roman'; line-height: 17px; background-color: #f6f6f6; font-size: medium;"> </span></p>
<pre>   <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">while</span><span class="p">(</span><span class="nb" style="line-height: 13px; color: #00aaaa;">true</span><span class="p">)</span> <span class="p">{</span>                    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Loop para sempre</span>
      <span class="n">pos</span><span class="o">=</span><span class="n">get_timer1</span><span class="p">()</span><span class="o">-</span><span class="n">period</span><span class="p">;</span>      <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Pega valor do timer, e subtrai do periodo</span>
                                    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Iremos usar isso para o tOn</span>
      <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">((</span><span class="n">pos</span><span class="o">&lt;=</span><span class="n">tOn</span><span class="p">)</span><span class="o">&amp;</span><span class="n">noteOn</span><span class="p">)</span>         <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se a posi&ccedil;&atilde;o for menor que o tOn </span>
         <span class="n">OUTPUT_HIGH</span><span class="p">(</span><span class="n">PIN_A0</span><span class="p">);</span>       <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Liga sa&iacute;da A0</span>
      <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">else</span>                          <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se n&atilde;o</span>
         <span class="n">OUTPUT_LOW</span><span class="p">(</span><span class="n">PIN_A0</span><span class="p">);</span>        <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Desliga sa&iacute;da A0</span>
         
    <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="n">buffer_loaded</span><span class="p">)</span> <span class="p">{</span>             <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Aqui iremos fazer o processo do buffer</span>
                                    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se o valor no byte1 for 0x90, e n&atilde;o houver</span>
                                    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//nota ligada, e o pino A1 estiver ligado </span>
       <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh" style="line-height: 13px; color: #000000;">0x90</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">noteOn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">PIN_A1</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">period</span> <span class="o">=</span> <span class="n">notas</span><span class="p">[</span><span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">1</span><span class="p">]];</span> <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Carrega o valor da nota no periodo</span>
         <span class="n">tON</span> <span class="o">=</span> <span class="p">(</span><span class="mh" style="line-height: 13px; color: #000000;">0xFFFF</span><span class="o">-</span><span class="n">period</span><span class="p">)</span><span class="o">*</span><span class="mf" style="line-height: 13px; color: #000000;">0.1</span><span class="p">;</span> <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Faz o tOn ser 10% do periodo total</span>
         <span class="n">noteOn</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">1</span><span class="p">;</span>                <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Fala que a nota est&aacute; ligada</span>
         <span class="n">OUTPUT_HIGH</span><span class="p">(</span><span class="n">PIN_A2</span><span class="p">);</span>       <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Coloca sa&iacute;da A2 em alta, PIC ocupado</span>
         <span class="n">loadedNote</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">1</span><span class="p">];</span>    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Guarda o n&uacute;mero da nota carregada</span>
       <span class="p">}</span><span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">else</span> <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh" style="line-height: 13px; color: #000000;">0x80</span><span class="p">)</span> <span class="p">{</span><span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Se for 0x80, &eacute; para desligar a nota</span>
       <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">loadedNote</span><span class="p">)</span> <span class="p">{</span><span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Verifica se a nota que esta tocando &eacute; a</span>
                                    <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//mesma que est&aacute; pedindo para desligar</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mh" style="line-height: 13px; color: #000000;">0xFFFF</span><span class="p">;</span>        <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Reseta periodo</span>
            <span class="n">noteOn</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>             <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Desliga nota</span>
            <span class="n">OUTPUT_LOW</span><span class="p">(</span><span class="n">PIN_A2</span><span class="p">);</span>     <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Desliga saida A2, PIC Dispon&iacute;vel</span>
            <span class="n">loadedNote</span> <span class="o">=</span> <span class="mh" style="line-height: 13px; color: #000000;">0x00</span><span class="p">;</span>      <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Zera nota carregada</span>
       <span class="p">}</span>
       <span class="p">}</span><span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">else</span> <span class="k" style="line-height: 13px; color: #0033cc; font-weight: bold;">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh" style="line-height: 13px; color: #000000;">0xB0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">period</span> <span class="o">=</span> <span class="mh" style="line-height: 13px; color: #000000;">0xFFFF</span><span class="p">;</span>           
         <span class="n">noteOn</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>                
         <span class="n">OUTPUT_LOW</span><span class="p">(</span><span class="n">PIN_A2</span><span class="p">);</span>        
         <span class="n">loadedNote</span> <span class="o">=</span> <span class="mh" style="line-height: 13px; color: #000000;">0x00</span><span class="p">;</span>
         <span class="n">buffer_counter</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>
         <span class="n">buffer_loaded</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="n">buffer_loaded</span> <span class="o">=</span> <span class="mi" style="line-height: 13px; color: #000000;">0</span><span class="p">;</span>           <span class="c1" style="line-height: 13px; color: #669933; font-style: italic;">//Libera o buffer para recarregamento</span>
    <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span></pre>
<p>&nbsp;</p>
<p>Com isso temos nosso c&oacute;digo completo!</p>
<p>A interface no PIC &eacute; bem simples como podemos ver abaixo:</p>
<p><a href="http://www.energylabs.com.br/el/pr/PIC&#32;Interface&#32;para&#32;MIDI" target="_blank"></a></p>
<p style="text-align: center;"><img border=0 title="PIC Interface para MIDI" src="get.php@arquivo=1533"  alt="PIC Interface para MIDI" width="600" height="398" /></p>
<p>Para um interruptor monofonico, podemos ligar o <em>Enable</em> no Vcc e ignorar o <em>BUSY</em>. Para um interruptor polifonico, podemos cascatear v&aacute;rios PIC's, ligando o <em>Enable</em> do primeiro no Vcc, e nos outros no <em>BUSY</em> do anterior. As entradas MIDI ficam todas em paralelo, e as sa&iacute;das s&atilde;o ligadas em gate OR:</p>
<p style="text-align: center;"><img border=0 title="PIC Interface para MIDI Polifonica" src="get.php@arquivo=1534"  alt="PIC Interface para MIDI Polifonica" width="592" height="709" /></p>
<p>A porta OR, pode ser simplificada com diodos sem problemas para este uso:</p>
<p style="text-align: center;"><img border=0 title="OR Gate with Diodes" src="get.php@arquivo=1532"  alt="OR Gate com Diodos" width="216" height="477" /></p>
<p>&nbsp;</p>
<p>&Eacute; isso ai! Qualquer d&uacute;vida use o f&oacute;rum!</p>
<p>C&oacute;digo fonte completo: <a href="get.php@arquivo=1536" target="_blank">MIDI INT.rar</a> ou <a href="get.php@dir=Meus&#32;Documentos%252FPIC&#32;Interruptor&#32;MIDI&#32;Polifonico%252Fsrc.html" target="_blank">Project Source</a></p>
<p>Cr&eacute;ditos pela id&eacute;ia de serializar microcontroladores para polifonia: uzzors2k - <a href="http://uzzors2k.4hv.org/index.php?page=midiinterrupter">http://uzzors2k.4hv.org/index.php?page=midiinterrupter</a></p>